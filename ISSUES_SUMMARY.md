# Issues Found & Solutions

## ‚úÖ ISSUE 1: Viva Question Generation - 400 Error
**Status:** FIXED

**Problem:** 
- Backend validation schema required both `subject` AND `topic` fields
- Frontend only sends `topic` field
- Validation middleware rejected requests with 400 error

**Solution:**
Updated `backend/src/middleware/validation.js`:
```javascript
// OLD (broken)
vivaRequest: Joi.object({
  subject: Joi.string().required(),  // ‚ùå Frontend doesn't send this
  topic: Joi.string().required(),
  documentId: Joi.string(),
  count: Joi.number().min(1).max(20).default(5),
  difficulty: Joi.string().valid('easy', 'medium', 'hard', 'mixed').default('mixed')
})

// NEW (fixed)
vivaRequest: Joi.object({
  topic: Joi.string().required(),  // ‚úÖ Only topic required
  documentId: Joi.string().allow('', null).optional(),
  count: Joi.number().min(1).max(20).default(5),
  includeMCQ: Joi.boolean().default(true)
})
```

**Test:** Try generating viva questions now - should work!

---

## ‚ùå ISSUE 2: AI Assistant Not Working - Gemini API Quota Exceeded
**Status:** NEEDS USER ACTION

**Problem:**
```
Error: [429 Too Many Requests] You exceeded your current quota
Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests
limit: 20, model: gemini-2.5-flash
Please retry in 49.565036565s
```

**Root Cause:**
- Gemini API free tier limit: **20 requests per day**
- You have exceeded this limit
- Affects: AI Assistant, Study Planner, Viva Question Generation

**Solutions:**

### Option 1: Wait (FREE)
- Wait until tomorrow (daily quota resets at midnight PST)
- Free tier limit: 20 requests/day

### Option 2: Upgrade to Paid Plan (RECOMMENDED)
1. Go to [Google AI Studio](https://aistudio.google.com/)
2. Click "Get API Key"
3. Upgrade to paid tier ($0.35 per 1M tokens)
4. Paid tier limits:
   - 2000 requests/day
   - 4M tokens/min
   - Much higher throughput

### Option 3: Use Different API Key
- Create new Google Cloud project
- Get new Gemini API key (fresh quota)
- Update `.env` file with new key

**Files Affected:**
- AI Assistant (`/api/chat/message`)
- Study Planner (`/api/study-plans/generate`)
- Viva Generation (`/api/viva/generate`)

---

## ‚ùå ISSUE 3: Document Processing - Missing Firestore Index
**Status:** NEEDS USER ACTION (5 min)

**Problem:**
```
Error: The query requires an index
Missing composite index:
- Collection: documents
- Fields: processingStatus (ASC) + userId (ASC) + createdAt (ASC)
```

**Root Cause:**
- Documents query uses multiple fields: `where('processingStatus', '==', 'completed').where('userId', '==', uid).orderBy('createdAt')`
- Firestore requires composite index for multi-field queries

**Solution:**
1. Click this URL (auto-generated by Firebase):
```
https://console.firebase.google.com/v1/r/project/sync-ai-5fe57/firestore/indexes?create_composite=Ck9wcm9qZWN0cy9zeW5jLWFpLTVmZTU3L2RhdGFiYXNlcy8oZGVmYXVsdCkvY29sbGVjdGlvbkdyb3Vwcy9kb2N1bWVudHMvaW5kZXhlcy9fEAEaFAoQcHJvY2Vzc2luZ1N0YXR1cxABGgoKBnVzZXJJZBABGg0KCWNyZWF0ZWRBdBACGgwKCF9fbmFtZV9fEAI
```

2. Click "Create Index" button
3. Wait 2-5 minutes for index to build
4. Refresh your app

**Files Affected:**
- AI Assistant context retrieval (fails to get relevant documents)
- Study Planner (fails to load syllabus documents)

---

## ‚ùì ISSUE 4: Study Planner Not Generating
**Status:** DEPENDENT ON ISSUE 2 & 3

**Problem:**
- Study planner depends on Gemini API for schedule generation
- Also needs documents for syllabus data

**Root Causes:**
1. **Gemini API quota exceeded** (Issue 2) - Can't generate AI schedule
2. **Missing Firestore index** (Issue 3) - Can't load syllabus documents

**Solution:**
Fix Issues 2 and 3 first, then study planner will work automatically.

**Code Status:** ‚úÖ Backend code is correct, routes properly configured

---

## ‚ùì ISSUE 5: "Doc Auto Add Data to Document Type"
**Status:** NEED CLARIFICATION

**What I See:**
- Documents endpoint working fine (304 responses)
- Document queries executing successfully
- No errors in document creation

**Possible Issues:**
1. Are you seeing duplicate documents?
2. Is the document type auto-selected when it shouldn't be?
3. Is uploaded document metadata being modified?

**Please clarify:** What exactly is happening with "doc auto add data"? 
- Screenshot?
- Specific steps to reproduce?
- What data is being auto-added?

---

## üìä Current System Status

### ‚úÖ WORKING Features:
- ‚úÖ Analytics Dashboard (all 5 charts loading)
- ‚úÖ User Authentication (Firebase Auth)
- ‚úÖ Document Upload/Download
- ‚úÖ Assignment Management
- ‚úÖ Viva Results History
- ‚úÖ User Stats
- ‚úÖ Habit Tracking

### ‚ö†Ô∏è PARTIALLY WORKING:
- ‚ö†Ô∏è Viva Question Generation (validation fixed, but needs Gemini quota)
- ‚ö†Ô∏è Study Planner (code correct, but needs Gemini quota + document index)
- ‚ö†Ô∏è AI Assistant (needs Gemini quota)

### ‚ùå NOT WORKING:
- ‚ùå Any AI-powered features (quota exceeded)
- ‚ùå Document context retrieval (missing index)

---

## üöÄ Quick Fix Checklist

### Immediate Actions (Do Now):

1. **Enable Firestore Index** (2 minutes)
   - Click the URL in Issue 3 above
   - Click "Create Index"
   - Wait 2-5 minutes

2. **Fix Gemini API Quota** (Choose one):
   - **Option A:** Wait until tomorrow (free)
   - **Option B:** Upgrade to paid tier (~$5/month for your usage)
   - **Option C:** Create new project with fresh API key

3. **Test Viva Generation** (30 seconds)
   - Go to Viva page
   - Enter a topic (e.g., "Operating Systems")
   - Click "Generate Questions"
   - Should work now (after fixing quota)

### Tomorrow (After Quota Reset):

4. **Test All AI Features:**
   - ‚úÖ AI Assistant chat
   - ‚úÖ Study Planner generation
   - ‚úÖ Viva Question generation

5. **Monitor Usage:**
   - Free tier: Max 20 requests/day
   - Consider upgrading if you need more

---

## üí° Recommendations

1. **Upgrade to Paid Tier** - You're actively developing and testing
   - Cost: ~$0.35 per 1M tokens (very cheap)
   - Benefit: 2000 requests/day vs 20

2. **Add Rate Limiting in Frontend** - Prevent quota exhaustion
   - Add cooldown between AI requests
   - Show quota usage to user
   - Cache AI responses when possible

3. **Add Better Error Messages**
   - Currently: Generic "failed to generate"
   - Better: "Daily quota exceeded. Try again tomorrow or upgrade plan"

4. **Enable All Required Indexes**
   - Check Firebase Console for any pending indexes
   - Create them proactively

---

## üîç What Was Actually Broken?

### Viva Generation:
- **Root Cause:** Validation schema mismatch
- **Fix Applied:** Updated validation to match frontend payload
- **Status:** FIXED ‚úÖ

### AI Features:
- **Root Cause:** API quota limit reached (20/day)
- **Fix Needed:** Wait or upgrade
- **Status:** USER ACTION REQUIRED ‚è≥

### Document Queries:
- **Root Cause:** Missing composite index
- **Fix Needed:** Create index in Firebase Console
- **Status:** USER ACTION REQUIRED ‚è≥

### Study Planner:
- **Root Cause:** Dependent on AI quota + document index
- **Fix Needed:** Fix dependencies first
- **Status:** DEPENDENT ‚è≥
